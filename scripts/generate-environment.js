const fs = require('fs');
const path = require('path');

function parseDotEnv(filePath) {
  if (!fs.existsSync(filePath)) return {};
  const content = fs.readFileSync(filePath, 'utf8');
  const lines = content.split(/\r?\n/);
  const env = {};
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const idx = trimmed.indexOf('=');
    if (idx === -1) continue;
    const key = trimmed.slice(0, idx).trim();
    const val = trimmed.slice(idx + 1).trim();
    env[key] = val.replace(/^"|"$/g, '');
  }
  return env;
}

const projectRoot = path.resolve(__dirname, '..');
const envFile = path.join(projectRoot, '.env');
const env = parseDotEnv(envFile);

const newsApiKey = env.NEWS_API_KEY || '';
const omdbApiKey = env.OMDB_API_KEY || '';
const countryApiKey = env.COUNTRY_API_KEY || '';

function writeEnvFile(targetPath, isProd) {
  const content = `// Generated by scripts/generate-environment.js
export const environment = {
  production: ${isProd},
  newsApiKey: '${newsApiKey}',
  omdbApiKey: '${omdbApiKey}',
  countryApiKey: '${countryApiKey}',
};
`;
  fs.writeFileSync(targetPath, content, 'utf8');
  console.log(`Wrote ${targetPath}`);
}

const devTarget = path.join(projectRoot, 'src', 'environments', 'environment.ts');
const prodTarget = path.join(projectRoot, 'src', 'environments', 'environment.prod.ts');

writeEnvFile(devTarget, false);
writeEnvFile(prodTarget, true);

console.log('Environment generation complete.');
